<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Only include this file when working with a ProjectReference; when using the NuGet package, this file will be
       included automatically via the consuming project's .nuget.g.props file. -->
  <Import Project="../../Lombiq.Npm.Targets/Lombiq.Npm.Targets.props"
          Condition="Exists('../../Lombiq.Npm.Targets/Lombiq.Npm.Targets.props')" />

  <PropertyGroup>
    <!-- Don't run any of the Node.js Extensions' heavy lifting during Visual Studio Design Time Builds to avoid hogging
         the CPU. See https://github.com/dotnet/project-system/blob/main/docs/design-time-builds.md for details. -->
    <NodeJsExtensionsShouldDoWork Condition="'$(DesignTimeBuild)' != 'true' OR '$(BuildingProject)' == 'true'">true</NodeJsExtensionsShouldDoWork>
    <NodeJsExtensionsInstallationPath>$(MSBuildThisFileDirectory.TrimEnd('/\'))</NodeJsExtensionsInstallationPath>
    <!-- The path where we copy the files necessary to install Node.js Extensions as an npm package. This will always be
         relative to the consuming project. -->
    <NodeJsExtensionsNpmPackageSourcePath>./node_modules/.nx</NodeJsExtensionsNpmPackageSourcePath>
    <!-- The "nodejs-extensions" part of this path is the name of the npm package as specified in package.json. -->
    <NodeJsExtensionsNpmPackageTargetPath>./node_modules/nodejs-extensions</NodeJsExtensionsNpmPackageTargetPath>
    <!-- The NodeJsExtensions*Folder paths are used by the npm scripts and can be adjusted in the consuming project. -->
    <NodeJsExtensionsDefaultTargetDirectory>wwwroot</NodeJsExtensionsDefaultTargetDirectory>
    <NodeJsExtensionsCreateStylelintConfigurationFile
      Condition="'$(NodeJsExtensionsCreateStylelintConfigurationFile)' == ''">true</NodeJsExtensionsCreateStylelintConfigurationFile>
    <!-- Overrides for properties defined by Lombiq.Npm.Targets.props. -->
    <NpmTargetsWorkingDirectory>$(NodeJsExtensionsNpmPackageSourcePath)</NpmTargetsWorkingDirectory>
    <NodeModulesFolderPath>$(NodeJsExtensionsNpmPackageSourcePath)/node_modules</NodeModulesFolderPath>
    <PackageJson>$(NodeJsExtensionsNpmPackageSourcePath)/package.json</PackageJson>
    <NpmInstallStampFile>$(NodeModulesFolderPath)/.install-stamp</NpmInstallStampFile>
    <!-- We put the stamp file into the consuming project's node_modules folder which we are certain exists after
         installing Node.js Extensions as an npm package there. See the AddNodeJsExtensionsAsNpmPackage target. -->
    <NpmDotnetPrebuildStampFile>$(MSBuildProjectDirectory)/node_modules/.dotnet-prebuild-stamp</NpmDotnetPrebuildStampFile>
    <!-- Using pnpm to avoid explosion of PATH environment variable due to multiple nested npm script invocations. -->
    <NpmDotnetPrebuildCommand Condition="'$(NuGetBuild)' != 'true'">pnpm build</NpmDotnetPrebuildCommand>
    <!-- During NuGet builds, we don't lint, we only compile. -->
    <NpmDotnetPrebuildCommand Condition="'$(NuGetBuild)' == 'true'">pnpm compile</NpmDotnetPrebuildCommand>
    <NpmDotnetPostcleanCommand>pnpm clean</NpmDotnetPostcleanCommand>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Read the consuming project's package.json file. -->
    <_NxPackageJsonContent>$([System.IO.File]::ReadAllText('$(MSBuildProjectDirectory)/package.json'))</_NxPackageJsonContent>
    <!-- Extract the "nodejsExtensions" property from it. The given regex extracts an object literal which contains only
         unnested child object literals (also inside arrays), as is the case with the current configuration schema. -->
    <_NxConfiguration>$([System.Text.RegularExpressions.Regex]::Match($(_NxPackageJsonContent), `"nodejsExtensions":\s*{([^{}]*{[^{}]*},?)+[^{}]*}`))</_NxConfiguration>
    <!-- Extract all "source" properties from the configuration. -->
    <_NxSourceProperties>$([System.Text.RegularExpressions.Regex]::Matches($(_NxConfiguration), `"source":\s*"([^"]+)"`))</_NxSourceProperties>
    <!-- Extract the "sources" property with an array value from the configuration. -->
    <_NxSourcesProperties>$([System.Text.RegularExpressions.Regex]::Match($(_NxConfiguration), `"sources":\s*\[([^\]]|\s)+\]`))</_NxSourcesProperties>
    <!-- Extract all values from the extracted "source" properties. -->
    <_NxSourceDirectoriesList>$([System.Text.RegularExpressions.Regex]::Replace($(_NxSourceProperties), `"source":\s*"`, ``).Replace(`"`, ``))</_NxSourceDirectoriesList>
    <!-- Extract all values from the extracted "sources" property. -->
    <_NxSourcesDirectoriesList>$([System.Text.RegularExpressions.Regex]::Replace($(_NxSourcesProperties), `"sources":\s*\[`, ``).Replace(`]`, ``).Replace(`"`, ``))</_NxSourcesDirectoriesList>
    <!-- Extract all "target" properties from the configuration. -->
    <_NxTargetProperties>$([System.Text.RegularExpressions.Regex]::Matches($(_NxConfiguration), `(?:"target":\s*")([^"]+)`))</_NxTargetProperties>
    <!-- Extract all values from the extracted "target" properties. -->
    <_NxTargetDirectoriesList>$([System.Text.RegularExpressions.Regex]::Replace($(_NxTargetProperties), `"target":\s*"`, ``).Replace(`"`, ``))</_NxTargetDirectoriesList>
  </PropertyGroup>
  
  <ItemGroup>
    <NodeJsExtensionsSourceDirectories Include="$(_NxSourceDirectoriesList.Split(';'))" />
    <NodeJsExtensionsSourceDirectories Include="$(_NxSourcesDirectoriesList.Split(','))" />
    <NodeJsExtensionsSourceFiles Include="%(NodeJsExtensionsSourceDirectories.Identity)/**/*" />
    <NodeJsExtensionsTargetDirectories Include="$(_NxTargetDirectoriesList.Split(';'))" />
  </ItemGroup>

  <ItemGroup>
    <NodeJsExtensionsNpmPackageFiles Include="$(NodeJsExtensionsInstallationPath)/.npmrc" />
    <NodeJsExtensionsNpmPackageFiles Include="$(NodeJsExtensionsInstallationPath)/package.json" />
    <!-- The ** is necessary so that the whole directory is copied over, not just the contained files. -->
    <NodeJsExtensionsNpmPackageFiles Include="$(NodeJsExtensionsInstallationPath)/**/config/**/*.*" />
    <NodeJsExtensionsNpmPackageFiles Include="$(NodeJsExtensionsInstallationPath)/**/scripts/*.*" />
    <NodeJsExtensionsNpmPackageFiles Include="$(NodeJsExtensionsInstallationPath)/**/Stylelint/*.*" />
    <NodeJsExtensionsNpmPackageFiles Remove="$(NodeJsExtensionsInstallationPath)/node_modules/**" />
  </ItemGroup>

</Project>
