<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Only include this file when working with a ProjectReference; when using the NuGet package, this file will be
       included automatically via the consuming project's .nuget.g.props file. -->
  <Import Project="../../Lombiq.Npm.Targets/Lombiq.Npm.Targets.targets"
          Condition="Exists('../../Lombiq.Npm.Targets/Lombiq.Npm.Targets.targets')" />

  <Import Project="build/NodeJsExtensionsNpmPackage.targets" />

  <PropertyGroup>
    <!-- Don't run any of the Node.js Extensions' heavy lifting during Visual Studio Design Time Builds. -->
    <ExecDotnetPostcleanCommand Condition="'$(NodeJsExtensionsShouldDoWork)' != 'true'">false</ExecDotnetPostcleanCommand>
    <ExecDotnetPrebuildCommand Condition="'$(NodeJsExtensionsShouldDoWork)' != 'true'">false</ExecDotnetPrebuildCommand>
    <NpmCommandsEnvironmentVariables>
      INIT_PWD=$(MSBuildProjectDirectory.Replace('\', '/'))/node_modules/nodejs-extensions;
    </NpmCommandsEnvironmentVariables>
    <!-- Figure out what to do about ESLint. -->
    <ScriptFilesToProcess>$([System.String]::Join(@(NodeJsExtensionsScriptFiles), ''))</ScriptFilesToProcess>
    <HasAnyScriptFilesToProcess Condition="'$(ScriptFilesToProcess)' != ''">true</HasAnyScriptFilesToProcess>
    <ShouldConfigureESLintPerProject Condition="
            '$(HasAnyScriptFilesToProcess)' == 'true'                         
            AND '$(NodeJsExtensionsGlobalESLintConfigurationDirectory)' == ''
            AND !Exists('$(MSBuildProjectDirectory)/.eslintrc.json')">true</ShouldConfigureESLintPerProject>
    <!-- Figure out what to do about Stylelint. -->
    <StyleFilesToProcess>$([System.String]::Join(@(NodeJsExtensionsStyleFiles), ''))</StyleFilesToProcess>
    <HasAnyStyleFilesToProcess Condition="'$(StyleFilesToProcess)' != ''">true</HasAnyStyleFilesToProcess>
    <ShouldConfigureStylelintPerProject Condition="
            '$(HasAnyStyleFilesToProcess)' == 'true'                         
            AND '$(NodeJsExtensionsGlobalESLintConfigurationDirectory)' == ''
            AND !Exists('$(MSBuildProjectDirectory)/.stylelintrc.json')">true</ShouldConfigureStylelintPerProject>
  </PropertyGroup>

  <!-- We need to install the project's npm packages first, so that the asset copy pipeline can actually copy them. -->
  <Target Name="InstallNpmPackagesInConsumingProject"
          BeforeTargets="NpmDotnetPrebuild"
          DependsOnTargets="InstallNodeJsExtensionsNpmPackage"
          Inputs="$(MSBuildProjectDirectory)/package.json"
          Outputs="$(MSBuildProjectDirectory)/node_modules/.nx_pnpm_install_stamp"
          Condition="'$(NodeJsExtensionsShouldDoWork)' == 'true'">
    <Message Text="Calling pnpm install in $(MSBuildProjectDirectory)" Importance="$(_NxVerbosity)" />
    <Exec Command="pnpm install" WorkingDirectory="$(MSBuildProjectDirectory)" StandardOutputImportance="$(_NxVerbosity)" />
    <Touch Files="$(MSBuildProjectDirectory)/node_modules/.nx_pnpm_install_stamp" AlwaysCreate="true" />
  </Target>

  <!--
    ============================================================
    InstallNodeJsExtensionsNpmPackage
    ============================================================
    -->
  <PropertyGroup>
    <InstallNodeJsExtensionsNpmPackageDependsOn Condition="'$(IsGlobalNodeJsExtensionsNpmPackage)' != 'true'">
      AddNodeJsExtensionsAsNpmPackage
    </InstallNodeJsExtensionsNpmPackageDependsOn>
  </PropertyGroup>
  <Target Name="InstallNodeJsExtensionsNpmPackage" DependsOnTargets="$(InstallNodeJsExtensionsNpmPackageDependsOn)">
    <!-- Place a .stylelintrc file into the consuming project that won't be overwritten subsequently, so may be adjusted
         there. To use a global .stylelintrc file, set <NodeJsExtensionsGlobalStylelintConfigurationDirectory> to the
         desired path. -->
    <Copy SourceFiles="$(NodeJsExtensionsNpmPackageSourcePath)/config/consumer/.stylelintrc.project.json"
          DestinationFiles="$(MSBuildProjectDirectory)/.stylelintrc.json"
          Condition="'$(ShouldConfigureStylelintPerProject)' == 'true'" />
    <!-- Place a .eslintrc file into the consuming project that won't be overwritten subsequently, so may be adjusted
         there. To use a global .eslintrc file, set <NodeJsExtensionsGlobalESLintConfigurationDirectory> to the desired
         path. -->
    <Copy SourceFiles="$(NodeJsExtensionsNpmPackageSourcePath)/config/consumer/.eslintrc.project.json"
          DestinationFiles="$(MSBuildProjectDirectory)/.eslintrc.json"
          Condition="'$(ShouldConfigureESLintPerProject)' == 'true'" />
    <!-- Here we link to Node.js Extensions as an npm package, which makes it available to the consumer project under
         its package name "nodejs-extensions". This needs the consumer to have a package.json file, so if there is none,
         we create a minimal one. -->
    <Copy SourceFiles="$(NodeJsExtensionsNpmPackageSourcePath)/config/consumer/package.project.json"
          DestinationFiles="$(MSBuildProjectDirectory)/package.json"
          Condition="'$(ShouldConfigureESLintPerProject)' == 'true' AND !Exists('$(MSBuildProjectDirectory)/package.json')" />
    <Copy SourceFiles="$(NodeJsExtensionsNpmPackageSourcePath)/config/consumer/package.minimal.json"
          DestinationFiles="$(MSBuildProjectDirectory)/package.json"
          Condition="'$(ShouldConfigureESLintPerProject)' != 'true' AND !Exists('$(MSBuildProjectDirectory)/package.json')" />
    <Exec Command="pnpm link $(NodeJsExtensionsNpmPackageSourcePath)" />
    <!-- Install all ESLint config dependencies of Node.js Extensions in the consumer project's directory. -->
    <!-- UNNECESSARY due to InstallNpmPackagesInConsumingProject ? -->
    <!--<Message Text="Calling pnpm install in $(MSBuildProjectDirectory):" Importance="$(_NxVerbosity)"
             Condition="!Exists($(NodeJsExtensionsGlobalESLintConfigurationDirectory))" />
    <Exec Command="pnpm install"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          Condition="!Exists($(NodeJsExtensionsGlobalESLintConfigurationDirectory))"
          StandardOutputImportance="$(_NxVerbosity)" />-->
  </Target>

  <!--
    ============================================================
    CleanNodeJsExtensionsNpmPackage
    ============================================================
    -->
  <PropertyGroup>
    <CleanNodeJsExtensionsNpmPackageDependsOn Condition="'$(IsGlobalNodeJsExtensionsNpmPackage)' != 'true' AND '$(DeveloperMode)' == 'true'">
      UpdateNodeJsExtensionsNpmPackage
    </CleanNodeJsExtensionsNpmPackageDependsOn>
  </PropertyGroup>
  <Target Name="CleanNodeJsExtensionsNpmPackage"
          BeforeTargets="Clean"
          DependsOnTargets="$(CleanNodeJsExtensionsNpmPackageDependsOn)"></Target>

  <!--
    ============================================================
    AddGeneratedFilesToEmbeddedResourceList

    Files that are generated during the build need to be added manually to the EmbeddedResource item group, else they
    won't be embedded in the DLL. See: https://github.com/dotnet/msbuild/issues/3271#issuecomment-386662451.
    ============================================================
    -->
  <Target
    Name="AddGeneratedFilesToEmbeddedResourceList"
    AfterTargets="NpmDotnetPrebuild"
    BeforeTargets="EmbeddModuleAssets;OrchardCoreEmbedModuleAssets;Compile"
    Condition="'$(NodeJsExtensionsShouldDoWork)' == 'true'">
    <ItemGroup>
      <NodeJsExtensionsTargetFiles Include="%(NodeJsExtensionsTargetDirectories.Identity)/**/*" />
    </ItemGroup>
    <Message Text="Adding the following to EmbeddedResource:%0a- @(NodeJsExtensionsTargetFiles,'%0a- ')" Importance="$(_NxVerbosity)" />
    <ItemGroup>
      <EmbeddedResource Include="@(NodeJsExtensionsTargetFiles)" WithCulture="false" Type="Non-Resx" />
    </ItemGroup>
  </Target>

  <!-- We print some helpful information here, but only when the verbosity is high enough. -->
  <Target Name="PrintDebugMessages" AfterTargets="AddGeneratedFilesToEmbeddedResourceList">
    <Message Text="*** START PRINTING NODEJS EXTENSIONS VALUES ***" Importance="$(_NxVerbosity)" />
    <Message Text="NodeJsExtensionsInstallationPath:     '$(NodeJsExtensionsInstallationPath)'" Importance="$(_NxVerbosity)" />
    <Message Text="NodeJsExtensionsNpmPackageSourcePath: '$(NodeJsExtensionsNpmPackageSourcePath)'" Importance="$(_NxVerbosity)" />
    <Message Text="NodeJsExtensionsNpmPackageTargetPath: '$(NodeJsExtensionsNpmPackageTargetPath)'" Importance="$(_NxVerbosity)" />
    <Message Text="NpmTargetsWorkingDirectory:           '$(NpmTargetsWorkingDirectory)'" Importance="$(_NxVerbosity)" />
    <Message Text="NpmInstallStampFile:                  '$(NpmInstallStampFile)'" Importance="$(_NxVerbosity)" />
    <Message Text="NpmDotnetPrebuildStampFile:           '$(NpmDotnetPrebuildStampFile)'" Importance="$(_NxVerbosity)" />
    <Message Text="NpmDotnetPrebuildWatchedFiles:%0a - @(NpmDotnetPrebuildWatchedFiles, '%0a - ')" Importance="$(_NxVerbosity)" />
    <Message Text="NodeJsExtensionsNpmPackageFiles:%0a - @(NodeJsExtensionsNpmPackageFiles,'%0a - ')" Importance="Low" />
    <Message Text="ScriptFilesToProcess:                 '$(ScriptFilesToProcess)'" Importance="$(_NxVerbosity)" />
    <Message Text="HasAnyScriptFilesToProcess:           '$(HasAnyScriptFilesToProcess)'" Importance="$(_NxVerbosity)" />
    <Message Text="StyleFilesToProcess:                  '$(StyleFilesToProcess)'" Importance="$(_NxVerbosity)" />
    <Message Text="HasAnyStyleFilesToProcess:            '$(HasAnyStyleFilesToProcess)'" Importance="$(_NxVerbosity)" />
    <Message Text="*** DONE PRINTING NODEJS EXTENSIONS VALUES ***" Importance="$(_NxVerbosity)" />
  </Target>

  <!-- The messages to search for in the build output, used in the Conditions, are defined in the package.json file. -->
  <Target Name="DetectNpmErrors" AfterTargets="NpmDotnetPrebuild">
    <PropertyGroup>
      <StylesWarning Condition="$(PrebuildOutput.Contains('Error in styles pipeline: linting failed'))">true</StylesWarning>
      <StylesError Condition="$(PrebuildOutput.Contains('Error in styles pipeline: compilation failed'))">true</StylesError>
      <ScriptsWarning Condition="$(PrebuildOutput.Contains('Error in scripts pipeline: linting failed'))">true</ScriptsWarning>
      <ScriptsError Condition="$(PrebuildOutput.Contains('Error in scripts pipeline: compilation failed'))">true</ScriptsError>
      <ScriptsError Condition="$(PrebuildOutput.Contains('Error in scripts pipeline: minification failed'))">true</ScriptsError>
    </PropertyGroup>
  </Target>

  <!-- In case of an error, delete the build stamp file so that the next run will re-generate the error. -->
  <Target
    Name="DeleteBuildStampFile"
    AfterTargets="DetectNpmErrors"
    DependsOnTargets="DeleteDotnetPrebuildStampFile"
    Condition="'$(StylesError)' == 'true'" />

  <!-- Generate build Warnings or Errors in case of errors during asset processing. -->
  <Target Name="GenerateWarningsAndErrors" AfterTargets="DeleteBuildStampFile">
    <Message Text="Running GenerateWarningsAndErrors for '$(MSBuildProjectName)'" />
    <Warning
      Code="NE11"
      Text="Styles linting error in Node.js Extensions script, check the build output for more information."
      Condition="'$(StylesWarning)' == 'true'" />
    <Error
      Code="NE12"
      Text="Styles pipeline error in Node.js Extensions script, check the build output for more information."
      Condition="'$(StylesError)' == 'true'" />
    <Warning
      Code="NE21"
      Text="Scripts linting error in Node.js Extensions script, check the build output for more information."
      Condition="'$(ScriptsWarning)' == 'true'" />
    <Error
      Code="NE22"
      Text="Scripts pipeline error in Node.js Extensions script, check the build output for more information."
      Condition="'$(ScriptsError)' == 'true'" />
  </Target>

  <Target Name="MarkdownValidation"
          DependsOnTargets="AddNodeJsExtensionsAsNpmPackage"
          AfterTargets="BeforeResolveReferences"
          BeforeTargets="BeforeCompile"
          Condition="'$(NodeJsExtensionsShouldDoWork)' == 'true' AND ('$(NodeJsExtensionsMarkdownAnalysisMode)' == 'true' OR '$(NodeJsExtensionsMarkdownAnalysisMode)' == 'solution')">
    <PropertyGroup Condition="'$(NodeJsExtensionsMarkdownAnalysisMode)' == 'solution'">
      <NodeJsExtensionsMarkdownAnalysisArgument>$(SolutionDir)</NodeJsExtensionsMarkdownAnalysisArgument>
    </PropertyGroup>

    <PropertyGroup Condition="'$(NodeJsExtensionsMarkdownAnalysisMode)' == 'true'">
      <NodeJsExtensionsMarkdownAnalysisArgument>$(ProjectDir)</NodeJsExtensionsMarkdownAnalysisArgument>
    </PropertyGroup>

    <Exec
      Command="pnpm lint:markdown:args --directory=$(NodeJsExtensionsMarkdownAnalysisArgument)"
      WorkingDirectory="$(NodeJsExtensionsNpmPackageSourcePath)" />
  </Target>

</Project>
